trigger:
  branches:
    include:
      - main

pool:
  name: 'SelfHostedLinux'

variables:
  azureSubscription: 'azure-prod-connection'
  webAppName: 'petclinic1'
  artifactName: 'spring-boot-app'

stages:
# =====================
# BUILD STAGE
# =====================
- stage: Build
  displayName: 'Build Stage'
  jobs:
    - job: BuildJob
      displayName: 'Build Spring Boot Application'
      steps:
        - script: |
            echo "Java version:"
            java -version
            echo "Maven version:"
            mvn -version
            mvn -U clean package -DskipTests -Dspring-javaformat.skip=true

          displayName: 'Build with Maven (System Java 17)'

        - script: |
            mkdir -p $(Build.ArtifactStagingDirectory)
            cp target/*.jar $(Build.ArtifactStagingDirectory)
            rm -f $(Build.ArtifactStagingDirectory)/*original.jar
          displayName: 'Collect JAR'

        - task: PublishPipelineArtifact@1
          displayName: 'Publish Artifact'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)'
            artifact: '$(artifactName)'

# =====================
# DEPLOY STAGE
# =====================
- stage: Deploy
  displayName: 'Deploy Stage'
  dependsOn: Build
  condition: succeeded()
  jobs:
    - deployment: DeployJob
      displayName: 'Deploy to Azure Web App'
      environment: 'test'
      pool:
        name: 'SelfHostedLinux'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadPipelineArtifact@2
                displayName: 'Download Artifact'
                inputs:
                  artifact: '$(artifactName)'
                  path: '$(Pipeline.Workspace)/artifact'

              - task: AzureWebApp@1
                displayName: 'Deploy to Azure Web App'
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webAppLinux'
                  appName: '$(webAppName)'
                  package: '$(Pipeline.Workspace)/artifact/*.jar'
                  runtimeStack: 'JAVA|17-java17'
